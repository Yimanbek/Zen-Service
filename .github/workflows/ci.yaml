name: CI Tests

on:
  push:
    branches:
      -  develop

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: ${USER}
          POSTGRES_PASSWORD: ${PASSWORD}
          POSTGRES_DB: ${TEST_DB_NAME}

      steps:
        - name: Checkout repo
          uses: actions/checkout@v3

        - name: Setup Python
          uses: actions/setup-python@v3
          with:
            python-version: '3.10'

        - name: Install dependencies
          run: |
            pip install -r requirements.txt
            pip install pytest pytest-django
        
        - name: Run tests
          env:
            DATABASE_URL: ${TEST_DATABASE_URL}
          run: pytest

        - name: Stopping test-db
          run: docker-compose down test-db